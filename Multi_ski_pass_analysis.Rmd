---
title: "Multi Ski Pass Exploratory Analysis"
author: "Winston Saunders"
date: "June 20, 2015"
output: 
  html_document:
    toc: true
    number_sections: true
---

##Summary  
This presentation looks at skier data in the form of chairlift rides for individual skip pass holders. Skier "days" for multiple seasons (05-06 to 14-15) were downloaded from a website which publishes them as a service to passholders. From each skier day a link was composed and used to get individual lift rides for each skier day.  

In many cases over 1000 ski runs were documented for an individual skier.  

The purpose of this exercise it to understand the reliability with which skier "fraud" (that is the use of a ski pass by other than the owner) can be detected from this data. 

Key findings include:   
1. Skier behavior is remarkably reproducile on a day to day basis.  


##Data Structure  

Data are read from previously downloaded data.  All ski runs for multiple seasons of individual skiers, including the date and time of a chairlift ride, and the chair elevation gain. Data for up to 122 skiers have been documented.  In the analysis below, to save time, only a subset are examined in these exploratory cases.

```{r, echo=FALSE}
library(timeDate)
library(chron)
library(ggplot2)
library(xtable)
library(digest)



Directory <- "/Users/winstonsaunders/Documents/Ski_data2/Pass_data/"
valid_pass<-list.files(Directory)
```
 
 
```{r "season function", echo=FALSE}

season_function <- function(date) {
        ## this recomputes the two-year representation of ski season from the date
        ## and returns the value as a character
        
        ss1 <- as.POSIXlt(date)
        
        ## compute the starting year of season
        if (as.integer(ss1$mon) > 8) {
            y1<-as.integer(ss1$year) + 1900
        } else {
            y1<-as.integer(ss1$year) + 1900 -1
            }
        
        ##get the last digits
        y1<-y1-2000
        y2<-y1+1
        
        if (y1<10) y1_char<-paste0("0", as.character(y1)) else y1_char <- as.character(y1)
        if (y2<10) y2_char<-paste0("0", as.character(y2)) else y2_char <- as.character(y2)
        
        season_character <- paste0(y1_char, "-", y2_char)
        
        return(season_character)
    
    }


```
 
```{r "ordered sample function", echo=FALSE}

ordered_sample <- function(dataframe, n=6) {
        ## this function creates an ordered sampling of n rows from a data frame
        
        ord_samp<-sample(1:nrow(dataframe), n)
        ord_samp<-sort(ord_samp, decreasing=TRUE)
        
        return(ord_samp)
    }


```

 
##Skier to Skier Variation of Daily Vertical   
 
The first analysis will look at skier to skier variation of daily vertical (that is the sum of the vertical feet for each chairlift ride on a given day). The question to be addressed is whether this provides a signature of the individual skier.  

A random sample of data from 23 out of the current `r length(valid_pass)` skiers is used. Below are the first few rows of the data. (NOTE - PASS NUMBERS HAVE BEEN HASHED TO PRESERVE ANONYMITY)

```{r, echo=FALSE, results='asis', fig.align='center'}
set.seed(8675309)
big_skier_record<-NULL

for (pass in sample(valid_pass, 23)) {
    ## read in the pass data
    # pass<-valid_pass[3]  ## for debug
    
    ski_runs<-read.csv(paste0(Directory, pass))
   
    
    ski_runs$weekend<-isWeekend(ski_runs$date)
    ski_runs$holiday<-isHoliday(as.timeDate(ski_runs$date), holidays = holidayNYSE(), wday = 1:5)
    ski_runs$bizday<-isBizday(as.timeDate(ski_runs$date))

    daily_vert<-rowsum(ski_runs$vertical_feet, ski_runs$date)
    daily_vert<-as.data.frame(daily_vert)
    daily_vert$date<-rownames(daily_vert)
    daily_vert$pass_id<-ski_runs$pass_id[1]


    daily_vert <- transform(daily_vert,
                        week = as.POSIXlt(date)$yday %/% 7 + 1,
                        season_week = (as.POSIXlt(date)$yday+31)%%365 %/% 7+1,
                        wday = as.POSIXlt(date)$wday,
                        year = as.POSIXlt(date)$year+1900,
                        weekend<-isWeekend(date),
                        holiday<-isHoliday(as.timeDate(date), holidays = holidayNYSE(2006:2015)),
                        bizday<-isBizday(as.timeDate(date), holidays = holidayNYSE(2006:2015))
)

    
    
    colnames(daily_vert)<-c("total_vertical","date", "pass","week","season_week" ,"wday", "year", "weekend", "holiday", "bizday")
    
    daily_vert$year<-as.factor(as.integer(daily_vert$year))
    ## hash the pass numbers
    daily_vert$pass<-digest(daily_vert$pass, algo="crc32")
    ## make seasons
    season<- sapply(daily_vert$date, season_function)
    season<-as.data.frame(season)
    daily_vert<-cbind(daily_vert, season)
    daily_vert$season<-as.factor(daily_vert$season)

    
    ## bind into big data frame
    big_skier_record<-rbind(big_skier_record, daily_vert)

}

  
print(xtable(big_skier_record[ordered_sample(big_skier_record, 30),]), type='html', comment=FALSE, include.rownames=FALSE, 
      html.table.attributes='border="2" padding="10" align="center" bgcolor="red"' )


```

There appears to be pretty good distinction between individual skiers. We can also check the data from season to season as below. Again, it appears to provide a reasonably consistent picture. 


```{r, echo=FALSE, fig.align="center", fig.height=5, fig.width=10}

 
p<-ggplot(big_skier_record, aes(x = pass, y= total_vertical, colour=factor(season))) 
p<-p+geom_boxplot(outlier.colour = NULL)
p<-p+theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
p<-p+ggtitle("pattern of daily vertical feet by skier")
p <- p + guides(color=guide_legend(nrow=5))
p <- p+ labs(x="skier (hashed)", y = "daily vertical (feet)")
print(p)
 
```



```{r}

q<-ggplot(big_skier_record, aes(total_vertical, fill=factor(pass)))
q<-q+geom_histogram(binwidth=2000, color='grey51')
print(q)



````


```{r}

q<-ggplot(big_skier_record, aes(total_vertical, fill=factor(season)))
q<-q+geom_histogram(binwidth=2000, color='grey51')
print(q)



````


```{r}

p<-ggplot(big_skier_record, aes(x = season, y= total_vertical, colour=factor(pass))) 
p<-p+geom_boxplot(outlier.colour = NULL)
p<-p+theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
p<-p+ggtitle("")
print(p)



````

```{r}

p<-ggplot(big_skier_record, aes(x = as.factor(wday), y= total_vertical, colour=factor(pass))) 
p<-p+geom_boxplot(outlier.colour = NULL)
p<-p+theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
p<-p+ggtitle("")
print(p)



````