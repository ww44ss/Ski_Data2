---
title: "Multi Ski Pass Exploratory Analysis"
author: "Winston Saunders"
date: "June 20, 2015"
output: 
  html_document:
    toc: true
    number_sections: true
---

#Summary  
This presentation looks at skier data in the form of chairlift rides for individual skip pass holders. Skier "days" for multiple seasons (05-06 to 14-15) were downloaded from a website which publishes them as a service to passholders. From each skier day a link was composed and used to get individual lift rides for each skier day.  

In many cases over 1000 ski runs were documented for an individual skier.  

The purpose of this exercise it to understand the reliability with which skier "fraud" (that is the use of a ski pass by other than the owner) can be detected from this data. 

Key findings include:   
1. Skier behavior is remarkably reproducile on a day to day basis.  


#Data Structure  

All ski runs for seasons 05-06 through 14-15 of individual skiers, including the date and time of every chairlift ride, and the chair elevation gain, are documented. Currently data for 122 skiers have been documented.  In the analysis below, to save time, only a subset are examined in these exploratory cases.  


```{r, echo=FALSE, warning=FALSE, message=FALSE}
library(timeDate)
library(chron)
library(ggplot2)
library(xtable)
library(digest)



Directory <- "/Users/winstonsaunders/Documents/Ski_data2/Pass_data/"
valid_pass<-list.files(Directory)
```
 
 
```{r "season function", echo=FALSE}

season_function <- function(date) {
        ## this recomputes the two-year representation of ski season from the date
        ## and returns the value as a character
        
        ss1 <- as.POSIXlt(date)
        
        ## compute the starting year of season
        if (as.integer(ss1$mon) > 8) {
            y1<-as.integer(ss1$year) + 1900
        } else {
            y1<-as.integer(ss1$year) + 1900 -1
            }
        
        ##get the last digits
        y1<-y1-2000
        y2<-y1+1
        
        if (y1<10) y1_char<-paste0("0", as.character(y1)) else y1_char <- as.character(y1)
        if (y2<10) y2_char<-paste0("0", as.character(y2)) else y2_char <- as.character(y2)
        
        season_character <- paste0(y1_char, "-", y2_char)
        
        return(season_character)
    
    }


```
 
```{r "ordered sample function", echo=FALSE}

ordered_sample <- function(dataframe, n=6) {
        ## this function creates an ordered sampling of n rows from a data frame
        
        ord_samp<-sample(1:nrow(dataframe), n)
        ord_samp<-sort(ord_samp, decreasing=TRUE)
        
        return(ord_samp)
    }


```


 
##Raw Data

<style>

table { 
    display: table;
    border-collapse: collapse;
    border-spacing: 10px;
    border-color: gray;
    background-color: #a0c0bf;
    text-align: center
    font: 12px arial, sans-serif;
}
th, td {
    
    padding: 5px;
}
</style>
 
Just to give a flavor for the data, here is a sample of ski runs for an individual skier. Note that the sample spans multiple years.  


```{r, echo=FALSE, results='asis', fig.align='center'}

holidays_season = holidayNYSE(2005:2015)

set.seed(8765309)

for (pass in sample(valid_pass, 1)) {
    ski_runs<-read.csv(paste0(Directory, pass))
    
    ## suppress pass_id
    ski_runs$pass_id<-NULL
    
    ski_runs$pass<-digest(ski_runs$pass, algo="crc32")
}

print(xtable(ski_runs[ordered_sample(ski_runs, 9),]), type='html', comment=FALSE, include.rownames=FALSE, 
      html.table.attributes='border="2" align="center" ' )

```

##Summarized for daily data

Each skier makes between about 50 and 200 runs per season, so we need a way to meaningfully summarize the data. First let's explore looking at daily total runs and vertical feet.



###Totals Runs Per Day

Here is a sample of the data for total runs per day per skier.

```{r, "runs_per_day",echo=FALSE, results='asis', fig.align='center'}
set.seed(8675309)
big_skier_record<-NULL

holidays_season = holidayNYSE(2005:2015)

for (pass in sample(valid_pass, 23)) {
    ## read in the pass data
    # pass<-valid_pass[3]  ## for debug
    
    ski_runs<-read.csv(paste0(Directory, pass))
   
    ski_runs$count <- 1
    
    ## use rowsum for calulate total vertical feet per unique day
    runs_per_day<-rowsum(ski_runs$count, ski_runs$date)
    runs_per_day<-as.data.frame(runs_per_day)
    runs_per_day$date<-rownames(runs_per_day)
    runs_per_day$pass_id<-ski_runs$pass_id[1]


    runs_per_day <- transform(runs_per_day,
                        week = as.POSIXlt(date)$yday %/% 7 + 1,
                        season_week = (as.POSIXlt(date)$yday+31)%%365 %/% 7+1,
                        wday = as.POSIXlt(date)$wday,
                        year = as.POSIXlt(date)$year+1900,
                        weekend<-isWeekend(date),
                        holiday<-isHoliday(as.timeDate(date), holidays = holidays_season),
                        bizday<-isBizday(as.timeDate(date), holidays = holidays_season)
)

    
    
    colnames(runs_per_day)<-c("runs_per_day","date", "pass","week","season_week" ,"wday", "year", "weekend", "holiday", "bizday")
    
    runs_per_day$year<-as.integer(runs_per_day$year)
    runs_per_day$week<-as.integer(runs_per_day$week)
    ## hash the pass numbers
    set.seed(911)
    runs_per_day$pass<-digest(runs_per_day$pass, algo="crc32")
    ## make seasons
    season<- sapply(runs_per_day$date, season_function)
    season<-as.data.frame(season)
    runs_per_day<-cbind(runs_per_day, season)
    runs_per_day$season<-as.factor(runs_per_day$season)

    
    ## bind into big data frame
    big_skier_record<-rbind(big_skier_record, runs_per_day)

}

set.seed(314159)


print(xtable(big_skier_record[ordered_sample(big_skier_record, 9),]), type='html', comment=FALSE, include.rownames=FALSE, 
      html.table.attributes='border="2" align="center" ' )

```
  
  
A random sample of data from 23 out of the `r length(valid_pass)` skiers is used. As can be seen from the graph below, the runs per skier are fairly consistent from season to season.  

```{r, echo=FALSE, fig.align="center", fig.height=5, fig.width=10}

 
p<-ggplot(big_skier_record, aes(x = pass, y= runs_per_day, colour=factor(season))) 
p<-p+geom_boxplot(outlier.colour = NULL)
p<-p+theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
p<-p+ggtitle("pattern of daily runs by skier")
p <- p + guides(color=guide_legend(nrow=5))
p <- p+ labs(x="skier (hashed)", y = "daily vertical (feet)")
print(p)
 
```

###Total Vertical Feet Per Day

We can also look at the number of vertical feet skied per day per skier. Again, most skiers seem to demonstrate fairly consistent behavior. 

```{r, "daily_vert",echo=FALSE, results='asis', fig.align='center'}
set.seed(8675309)
big_skier_record<-NULL

holidays_season = holidayNYSE(2005:2015)

for (pass in sample(valid_pass, 8)) {
    ## read in the pass data
    # pass<-valid_pass[3]  ## for debug
    
    ski_runs<-read.csv(paste0(Directory, pass))
   
    
    ski_runs$weekend<-isWeekend(ski_runs$date)
    ski_runs$holiday<-isHoliday(as.timeDate(ski_runs$date), holidays = holidays_season, wday = 1:5)
    ski_runs$bizday<-isBizday(as.timeDate(ski_runs$date))

    ## use rowsum for calulate total vertical feet per unique day
    daily_vert<-rowsum(ski_runs$vertical_feet, ski_runs$date)
    daily_vert<-as.data.frame(daily_vert)
    daily_vert$date<-rownames(daily_vert)
    daily_vert$pass_id<-ski_runs$pass_id[1]


    daily_vert <- transform(daily_vert,
                        week = as.POSIXlt(date)$yday %/% 7 + 1,
                        season_week = (as.POSIXlt(date)$yday+31)%%365 %/% 7+1,
                        wday = as.POSIXlt(date)$wday,
                        year = as.POSIXlt(date)$year+1900,
                        weekend<-isWeekend(date),
                        holiday<-isHoliday(as.timeDate(date), holidays = holidays_season),
                        bizday<-isBizday(as.timeDate(date), holidays = holidays_season)
)

    
    
    colnames(daily_vert)<-c("total_vertical","date", "pass","week","season_week" ,"wday", "year", "weekend", "holiday", "bizday")
    
    daily_vert$year<-as.factor(as.integer(daily_vert$year))
    ## hash the pass numbers
    daily_vert$pass<-digest(daily_vert$pass, algo="crc32")
    ## make seasons
    season<- sapply(daily_vert$date, season_function)
    season<-as.data.frame(season)
    daily_vert<-cbind(daily_vert, season)
    daily_vert$season<-as.factor(daily_vert$season)

    
    ## bind into big data frame
    big_skier_record<-rbind(big_skier_record, daily_vert)

}

set.seed(314159)


print(xtable(big_skier_record[ordered_sample(big_skier_record, 9),]), type='html', comment=FALSE, include.rownames=FALSE, 
      html.table.attributes='border="2" align="center" ' )

```


 

A random sample of data from 23 out of the current `r length(valid_pass)` skiers is used. Below are the first few rows of the data. (NOTE - PASS NUMBERS HAVE BEEN HASHED TO PRESERVE ANONYMITY)

There appears to be pretty good distinction between individual skiers. We can also check the data from season to season as below. Again, it appears to provide a reasonably consistent picture. 


```{r, echo=FALSE, fig.align="center", fig.height=5, fig.width=10}

 
p<-ggplot(big_skier_record, aes(x = pass, y= total_vertical, colour=factor(season))) 
p<-p+geom_boxplot(outlier.colour = NULL)
p<-p+theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
p<-p+ggtitle("pattern of daily vertical feet by skier")
p <- p + guides(color=guide_legend(nrow=5))
p <- p+ labs(x="skier (hashed)", y = "daily vertical (feet)")
print(p)
 
```



```{r, echo=FALSE, fig.align="center", fig.height=5, fig.width=10}

q<-ggplot(big_skier_record, aes(total_vertical, ..density.., color=factor(pass)))
q<-q+geom_histogram(binwidth=2000, fill='grey51', position="dodge", alpha=0.08)
q<-q+geom_density()
q <- q + guides(color=guide_legend(nrow=10))
print(q)



```


##Skier Speed Analytics

To analyze skier speed we need to add some more data. While the pass data tracks the vertical rise of the chairlift ride, the descent, which is the actual skiing part, is to the base of the next chairlift. Base elevations are not supplied with the downloaded data so need to be added. We can get some more data from the [Master Development Plan](http://www.mtbachelor.com/site/about_us/company_info/forest_service/MDP_Text.pdf)

```{r "base elevations", echo=FALSE}

    ## Add base elevation and nominal chairlift ride time to the data

    ## Data input
    ## base elev is in feet
    base_elev <- as.integer(c(6477,  6405,  6335, 7248, 6389, 6379, 6344, 5983,  5709))
    
    chair_names<-c("Sunrise","Rainbow","Skyliner","Summit","Sunshine", "Pine Marten","Red" , "Outback" , "Northwest" )
    
    ## ride time is in minutes
    ride_time <- c(4.2, 11.03,  5.97, 4.67, 2.13, 4.85, 8.46, 7.01,  8.38)
    
    ## create look_up table for base and ride time data by chairlift
    look_up <- matrix(c(ride_time, base_elev), 9,2, dimnames=list(chair_names, c("ride_time", "base_elev")))
    
    ## index it to the ski_runs
    i<-cbind(match(ski_runs$chair, rownames(look_up)))
    
    
    
    ## add columns to the data frame
    ski_runs<- cbind(ride_time=look_up[i,1], base_elev=look_up[i,2], ski_runs)

    print(head(ski_runs))

```

```{r, "ski descent time"}
    
    ## Calculate ski descent time and vertical / time
    ## the general approach will be to calculate first for each run (chair ride),
    ##      a start time, 
    ##      a start elevation, an end time, and an end elevation. 
    ##
    ## from there can calculate for each run the vertical / time of the skier.
    
    ## to start we need to break down the data into individual ski days
    
    ## create data frame columns
    ## since the end time of a run is the start time of the next run, we'll move 
    ## the data over. We'll also need to duplicate the data from teh first run of the day 
    ## assuming the day ends where it started. 
    
    ski_runs$elev_end<-ski_runs$base_elev
    ski_runs$chair_combo<-as.character(ski_runs$chair)
    ski_runs$time_end<-as.character(ski_runs$time)
    
    
    
    ## this need to be done on a day by day basis so we'll need to pull the data apart
    ## on a day by day basis.
    ## first step is grab unique days
    ski_days<-unique(ski_runs$date)
    
    ## define accumulator data frame
    ski_start_stop<-NULL
    
    for (days in ski_days) {
        
        ## get runs for specific day
        ss<-ski_runs[ski_runs$date==days,]
        
        
        
        shift2 <- function(x, n) c(tail(x, -n), rep(NA, n))
        
        ss<-transform(ss, elev_end = shift2(elev_end, 1))
        ss<-transform(ss, time_end = shift2(time_end, 1))
        ss<-transform(ss, chair_combo = shift2(chair_combo, 1))
        
        ## fix chair combo
        ss$chair_combo[nrow(ss)]<-as.character(ss$chair[1])
        
        ss$ski_time<-difftime(strptime(ss$time_end, "%Y-%m-%d %H:%M:%S"),strptime(ss$time, "%Y-%m-%d %H:%M:%S"), units = "mins" )[[1]]
        
        ## calulate vertical feet/minute correcting for chairlift time
        ss$ski_speed<-(ss$base_elev+ss$vertical_feet)/(ss$ski_time-ss$ride_time)
        ss$chair_combo <- paste(ss$chair, as.character(ss$chair_combo))
        
        ski_start_stop<-rbind(ski_start_stop, ss)
    }
    
    
print(ski_start_stop[1:30,  ])

```

So let's look at ski speed to see if more related to a skier or to a ski run.

```{r, echo=FALSE, fig.align="center", fig.height=7, fig.width=10}

 
p<-ggplot(ski_start_stop, aes(x = pass_id, y= ski_speed)) 
p<-p+geom_boxplot(outlier.colour = NULL)
p<-p+theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
p<-p+ggtitle("pattern of skier speed")
p <- p + guides(color=guide_legend(nrow=15))
p <- p+ labs(x="skier (hashed)", y = "ski speed (vertical feet/minute)")
print(p)
 
```